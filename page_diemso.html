<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra c·ª©u k·∫øt qu·∫£ h·ªçc t·∫≠p</title>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }

        .container { max-width: 1400px; margin: auto; background: #fff; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }

        .header { background: linear-gradient(135deg, #2c3e50, #34495e); padding: 30px; text-align: center; color: white; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }

        .search-section { background: #f8f9fa; padding: 30px; border-bottom: 1px solid #e9ecef; }
        .search-box { max-width: 800px; margin: auto; display: flex; gap: 10px; flex-wrap: wrap; }
        .search-row { display: flex; width: 100%; gap: 10px; margin-bottom: 15px; }
        .search-input { flex: 1; padding: 15px 20px; border-radius: 10px; border: 2px solid #ddd; font-size: 16px; }
        .search-input:focus { border-color: #667eea; box-shadow: 0 0 10px rgba(102,126,234,0.3); }
        .search-select { padding: 15px 20px; border-radius: 10px; border: 2px solid #ddd; font-size: 16px; background: white; min-width: 200px; }
        .search-btn { padding: 15px 30px; background: linear-gradient(135deg,#667eea,#764ba2);
            border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .search-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
        .reset-btn { padding: 15px 30px; background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .reset-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(149,165,166,0.4); }

        .table-container { overflow-x: auto; margin-top: 20px; padding: 0 20px 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #2c3e50; color: white; padding: 15px; text-align: left; position: sticky; top: 0; text-align: center; }
        td { padding: 12px 15px; border-bottom: 1px solid #e9ecef; }
        tr:hover { background: #f8f9fa; }
        tr.highlight { background: #fff176 !important; font-weight: bold; }

        .loading { text-align: center; padding: 40px; font-size: 1.2em; }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top: 4px solid #667eea;
            border-radius: 50%; animation: spin 1s linear infinite; margin: auto; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .score-cell { text-align: center; }
        .score-excellent { background: #d4efdf; color: #27ae60; padding: 5px 10px; border-radius: 20px; }
        .score-good { background: #d6eaf8; color: #3498db; padding: 5px 10px; border-radius: 20px; }
        .score-average { background: #fcf3cf; color: #f39c12; padding: 5px 10px; border-radius: 20px; }
        .score-poor { background: #f5b7b1; color: #e74c3c; padding: 5px 10px; border-radius: 20px; }

        .time-badge { background: #d6eaf8; padding: 5px 10px; border-radius: 12px; color: #1f618d; }

        .student-info { background: #e8f5e8; margin: 20px; padding: 20px; border-radius: 10px;
            border-left: 5px solid #27ae60; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(250px,1fr)); gap: 20px; margin-top: 15px; }
        .info-item { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .search-options { display: flex; gap: 15px; margin-bottom: 15px; }
        .search-option { display: flex; align-items: center; gap: 5px; }
        
        .results-info { background: #e3f2fd; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; }
        
        /* N√∫t l√™n ƒë·∫ßu trang */
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border: none;
            transition: all 0.3s ease;
            opacity: 0;
            visibility: hidden;
            z-index: 1000;
            transform: translateY(20px);
        }
        
        .back-to-top.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .back-to-top:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6);
            background: linear-gradient(135deg, #764ba2, #667eea);
        }
        
        .back-to-top:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        @media (max-width: 768px) {
            .search-row { flex-direction: column; }
            .search-select { min-width: 100%; }
            .back-to-top {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <script src="components/navbar.js"></script>
    <script>loadNavbar();</script>
    
    <div class="container">

        <div class="header">
            <h1>üéì H·ªÜ TH·ªêNG TRA C·ª®U K·∫æT QU·∫¢</h1>
            <p>Tra c·ª©u k·∫øt qu·∫£ h·ªçc t·∫≠p tr·ª±c tuy·∫øn</p>
        </div>

        <div class="search-section">
            <div class="search-box">
                <div class="search-row">
                    <select id="searchColumn" class="search-select">
                        <option value="2">T√¨m theo H·ªç v√† t√™n</option>
                        <option value="4">T√¨m theo L·ªõp</option>
                        <option value="1">T√¨m theo Th·ªùi gian</option>
                        <option value="2">T√¨m theo ƒêi·ªÉm</option>
                        <option value="5">T√¨m theo Nh·∫≠n x√©t</option>
                    </select>
                    <input id="searchInput" class="search-input" placeholder="Nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m ki·∫øm...">
                </div>
                <div class="search-row">
                    <button class="search-btn" onclick="searchStudent()">üîç T√¨m ki·∫øm</button>
                    <button class="reset-btn" onclick="resetSearch()">üîÑ Hi·ªÉn th·ªã t·∫•t c·∫£</button>
                </div>
            </div>
        </div>

        <div id="studentResult"></div>

        <div class="table-container">
            <div id="resultsInfo" class="results-info" style="display: none;">
                <span id="resultsCount">ƒêang t√¨m ki·∫øm...</span>
                <span id="searchCriteria"></span>
            </div>
            <div id="sheetData" class="loading">
                <div class="loading-spinner"></div>
                ƒêang t·∫£i d·ªØ li·ªáu...
            </div>
        </div>
    </div>

    <!-- N√∫t l√™n ƒë·∫ßu trang -->
    <button class="back-to-top" id="backToTop" onclick="scrollToTop()" title="L√™n ƒë·∫ßu trang">
        ‚Üë
    </button>

<script>
    const SHEET_ID = "18JkGwtftDdCK5PSrzqsTkMdxH7XWLpjsW1IHjR7vADQ";
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

    let cachedData = null;
    let normalizedData = null;
    let currentSearchResults = null;

    // D·ªØ li·ªáu m·∫´u ƒë·ªÉ demo (s·∫Ω ƒë∆∞·ª£c thay th·∫ø b·∫±ng d·ªØ li·ªáu th·ª±c t·ª´ Google Sheets)
    const sampleData = [
        ["STT", "Th·ªùi gian", "ƒêi·ªÉm", "H·ªç v√† t√™n", "L·ªõp", "M√¥n h·ªçc", "Nh·∫≠n x√©t"],
        ["1", "15/09/2023", "8.5", "Nguy·ªÖn VƒÉn T√∫", "10A1", "To√°n", "H·ªçc l·ª±c kh√°, c·∫ßn c·ªë g·∫Øng h∆°n"],
        ["2", "16/09/2023", "9.2", "Tr·∫ßn Th·ªã Minh", "10A2", "VƒÉn", "H·ªçc l·ª±c gi·ªèi, c√≥ ti·∫øn b·ªô"],
        ["3", "17/09/2023", "7.8", "L√™ VƒÉn An", "10A1", "Anh", "H·ªçc l·ª±c kh√°, chƒÉm ch·ªâ"],
        ["4", "18/09/2023", "6.5", "Ph·∫°m Th·ªã Dung", "10A3", "L√Ω", "H·ªçc l·ª±c trung b√¨nh, c·∫ßn n·ªó l·ª±c"],
        ["5", "19/09/2023", "8.9", "Ho√†ng VƒÉn B√¨nh", "10A2", "H√≥a", "H·ªçc l·ª±c kh√° gi·ªèi"],
        ["6", "20/09/2023", "9.5", "V≈© Th·ªã C√∫c", "10A1", "Sinh", "H·ªçc l·ª±c xu·∫•t s·∫Øc"],
        ["7", "21/09/2023", "7.2", "ƒê·∫∑ng VƒÉn ƒê·∫°t", "10A3", "S·ª≠", "H·ªçc l·ª±c kh√°"],
        ["8", "22/09/2023", "8.1", "B√πi Th·ªã Em", "10A2", "ƒê·ªãa", "H·ªçc l·ª±c kh√°, ti·∫øn b·ªô"],
        ["9", "23/09/2023", "6.8", "Mai VƒÉn Giang", "10A1", "GDCD", "H·ªçc l·ª±c trung b√¨nh kh√°"],
        ["10", "24/09/2023", "9.8", "L√Ω Th·ªã Hoa", "10A3", "To√°n", "H·ªçc l·ª±c xu·∫•t s·∫Øc, c√≥ nƒÉng khi·∫øu"]
    ];

    function removeVietnameseTones(str) {
        return str.normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/ƒë/g, "d").replace(/ƒê/g, "D")
            .toLowerCase().trim();
    }

    // H√†m tr√≠ch xu·∫•t CH·ªÆ C√ÅI ƒê·∫¶U TI√äN c·ªßa T√äN
    function extractFirstLetterOfLastName(fullName) {
        if (!fullName) return '';
        
        // T√°ch chu·ªói th√†nh m·∫£ng c√°c t·ª´
        const words = fullName.trim().split(' ');
        
        // L·∫•y t·ª´ cu·ªëi c√πng (t√™n)
        const lastName = words[words.length - 1];
        
        // L·∫•y ch·ªØ c√°i ƒë·∫ßu ti√™n c·ªßa t√™n v√† chuy·ªÉn th√†nh ch·ªØ th∆∞·ªùng
        const firstLetter = lastName.charAt(0).toLowerCase();
        
        return removeVietnameseTones(firstLetter);
    }

    // H√†m s·∫Øp x·∫øp d·ªØ li·ªáu theo CH·ªÆ C√ÅI ƒê·∫¶U c·ªßa T√äN A-Z
    function sortDataByFirstNameLetter(data) {
        if (!data || data.length <= 1) return data;
        
        const headers = data[0];
        const rows = data.slice(1);
        
        // S·∫Øp x·∫øp c√°c h√†ng theo CH·ªÆ C√ÅI ƒê·∫¶U c·ªßa T√äN
        const sortedRows = rows.sort((a, b) => {
            const letterA = extractFirstLetterOfLastName(a[3]); // C·ªôt H·ªç v√† t√™n l√† index 3
            const letterB = extractFirstLetterOfLastName(b[3]);
            
            return letterA.localeCompare(letterB);
        });
        
        return [headers, ...sortedRows];
    }

    async function loadSheetData() {
        try {
            const response = await fetch(`${SHEET_URL}&t=${Date.now()}`);
            const text = await response.text();
            const json = JSON.parse(text.substring(47).slice(0, -2));

            const rows = json.table.rows;
            const headers = json.table.cols.map(c => c.label);
            const data = [headers];

            rows.forEach(r => {
                const row = r.c.map((c, index) => {
                    if (!c) return "";
                    
                    // X·ª≠ l√Ω c·ªôt ng√†y th√°ng
                    if (c.f && headers[index].toLowerCase().includes('th·ªùi gian')) {
                        const fullDate = c.f;
                        // Ch·ªâ l·∫•y ph·∫ßn ng√†y (b·ªè gi·ªù) - "17/11/2025"
                        return fullDate.split(' ')[0];
                    }
                    
                    return c.v ? c.v : "";
                });
                data.push(row);
            });

            // S·∫ÆP X·∫æP D·ªÆ LI·ªÜU THEO CH·ªÆ C√ÅI ƒê·∫¶U C·ª¶A T√äN A-Z T·ª∞ ƒê·ªòNG
            cachedData = sortDataByFirstNameLetter(data);
            
            // Chu·∫©n h√≥a d·ªØ li·ªáu ƒë·ªÉ t√¨m ki·∫øm
            normalizedData = cachedData.slice(1).map(row => ({
                original: row,
                normalized: row.map(cell => removeVietnameseTones(String(cell)))
            }));
            
            displayData(cachedData);
        } catch (error) {
            console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", error);
            // S·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u
            cachedData = sortDataByFirstNameLetter(sampleData);
            normalizedData = cachedData.slice(1).map(row => ({
                original: row,
                normalized: row.map(cell => removeVietnameseTones(String(cell)))
            }));
            displayData(cachedData);
            
            document.getElementById("sheetData").innerHTML = `
                <div style="background:#fff3cd;padding:20px;border-radius:10px;border-left:5px solid #ffc107;">
                    <h3>‚ö†Ô∏è ƒêang s·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u</h3>
                    <p>Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn Google Sheets. ƒêang s·ª≠ d·ª•ng d·ªØ li·ªáu demo.</p>
                </div>`;
        }
    }

    function displayData(data, highlightRows = []) {
        const headers = data[0];
        const rows = data.slice(1);



        //let html = `<table><thead><tr>${headers.map((h, i) => `<th data-column="${i}">${h}</th>`).join("")}</tr></thead><tbody>`;

        const columnsToShow = [0, 1, 2, 3, 4, 5]; // STT, ƒêi·ªÉm, H·ªç v√† t√™n, Nh·∫≠n x√©t
    
        let html = `<table><thead><tr>${columnsToShow.map(i => `<th>${headers[i]}</th>`).join("")}</tr></thead><tbody>`;

        // rows.forEach((row, rowIndex) => {
        //     const isHighlighted = highlightRows.includes(rowIndex);

        //     // hi·ªÉn th·ªã n·ªôi dung c√°c c·ªôt
        //     html += `<tr class="${isHighlighted ? 'highlight' : ''}">${row.map((cell, i) => {
        //         if (i === 1) return `<td><span class="time-badge">${cell}</span></td>`;
        //         if (i === 2) {
        //             const s = parseFloat(cell);
        //             return `<td class="score-cell ${getScoreClass(s)}" style="background:#a8f0a5; color:#000; font-weight:bold;">${cell}</td>`;
        //         }
        //         return `<td>${cell}</td>`;
        //     }).join("")}</tr>`;
        // });

        rows.forEach((row, rowIndex) => {
        const isHighlighted = highlightRows.includes(rowIndex);
        
        // CH·ªà l·∫•y c√°c √¥ trong columnsToShow
        html += `<tr class="${isHighlighted ? 'highlight' : ''}">${columnsToShow.map(columnIndex => {
            const cell = row[columnIndex];
            
            // √Åp d·ª•ng ƒë·ªãnh d·∫°ng ƒë·∫∑c bi·ªát cho c√°c c·ªôt c·ª• th·ªÉ
            if (columnIndex === 1) { // C·ªôt Th·ªùi gian
                return `<td><span class="time-badge">${cell}</span></td>`;
            }
            if (columnIndex === 2) { // C·ªôt ƒêi·ªÉm
                const s = parseFloat(cell);
                return `<td class="score-cell ${getScoreClass(s)}" style="background:#a8f0a5; color:#000; font-weight:bold;">${cell}</td>`;
            }
            // C√°c c·ªôt c√≤n l·∫°i hi·ªÉn th·ªã b√¨nh th∆∞·ªùng
            return `<td>${cell}</td>`;
        }).join("")}</tr>`;
    });

        html += "</tbody></table>";
        document.getElementById("sheetData").innerHTML = html;
    }

    function getScoreClass(s) {
        if (s >= 900) return "score-excellent";
        if (s >= 800) return "score-good";
        if (s >= 700) return "score-average";
        return "score-poor";
    }

    function searchStudent() {
        const input = document.getElementById("searchInput").value;
        const columnIndex = parseInt(document.getElementById("searchColumn").value);
        const keyword = removeVietnameseTones(input);

        if (!normalizedData) {
            alert("D·ªØ li·ªáu ch∆∞a ƒë∆∞·ª£c t·∫£i xong. Vui l√≤ng ƒë·ª£i...");
            return;
        }

        if (!keyword) {
            alert("Vui l√≤ng nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm!");
            return;
        }

        // T√¨m ki·∫øm trong c·ªôt ƒë∆∞·ª£c ch·ªçn
        const foundRows = [];
        const highlightIndexes = [];

        normalizedData.forEach((item, index) => {
            if (item.normalized[columnIndex].includes(keyword)) {
                foundRows.push(item.original);
                highlightIndexes.push(index);
            }
        });

        // Hi·ªÉn th·ªã k·∫øt qu·∫£
        if (foundRows.length > 0) {
            displayData(cachedData, highlightIndexes);
            
            document.getElementById("resultsInfo").style.display = "flex";
            document.getElementById("resultsCount").textContent = `T√¨m th·∫•y ${foundRows.length} k·∫øt qu·∫£`;
            document.getElementById("searchCriteria").textContent = `T√¨m theo "${cachedData[0][columnIndex]}" v·ªõi t·ª´ kh√≥a "${input}"`;
            
            displaySearchResult(foundRows[0], input, columnIndex);
            
            // Cu·ªôn ƒë·∫øn k·∫øt qu·∫£ ƒë·∫ßu ti√™n
            if (highlightIndexes.length > 0) {
                const table = document.querySelector("table tbody");
                const firstRow = table.getElementsByTagName("tr")[highlightIndexes[0]];
                firstRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        } else {
            displayData(cachedData);
            document.getElementById("resultsInfo").style.display = "flex";
            document.getElementById("resultsCount").textContent = "Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o";
            document.getElementById("searchCriteria").textContent = `T√¨m theo "${cachedData[0][columnIndex]}" v·ªõi t·ª´ kh√≥a "${input}"`;
            
            document.getElementById("studentResult").innerHTML = `
                <div style="background:#ffeaea;padding:20px;margin:20px;border-radius:10px;border-left:5px solid #e74c3c;">
                    <h3>‚ùå Kh√¥ng t√¨m th·∫•y</h3>
                    <p>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o v·ªõi t·ª´ kh√≥a "<b>${input}</b>" trong c·ªôt <b>${cachedData[0][columnIndex]}</b></p>
                </div>`;
        }
        
        currentSearchResults = foundRows;
    }

    function resetSearch() {
        document.getElementById("searchInput").value = "";
        document.getElementById("searchColumn").selectedIndex = 0;
        document.getElementById("resultsInfo").style.display = "none";
        document.getElementById("studentResult").innerHTML = "";
        displayData(cachedData);
        currentSearchResults = null;
    }

    function displaySearchResult(data, keyword, columnIndex) {
        const resultDiv = document.getElementById("studentResult");
        const columnNames = cachedData[0];

        resultDiv.innerHTML = `
            <div class="student-info">
                <h3>‚úÖ T√¨m th·∫•y k·∫øt qu·∫£</h3>
                <p>T√¨m th·∫•y k·∫øt qu·∫£ v·ªõi t·ª´ kh√≥a "<b>${keyword}</b>" trong c·ªôt <b>${columnNames[columnIndex]}</b></p>

                <div class="info-grid">
                    <div class="info-item"><b>üë§ H·ªç t√™n:</b> ${data[2]}</div>
                    <div class="info-item"><b>üè´ L·ªõp:</b> ${data[3]}</div>
                    <div class="info-item"><b>‚è∞ Th·ªùi gian:</b> <span class="time-badge">${data[0]}</span></div>
                    <div class="info-item"><b>üìä ƒêi·ªÉm:</b> <span class="${getScoreClass(parseFloat(data[1]))}">${data[1]}</span></div>
                    <div class="info-item" style="grid-column:1/-1;"><b>üí¨ Nh·∫≠n x√©t:</b> "${data[5]}"</div>
                </div>
            </div>
        `;
    }

    // H√†m cu·ªôn l√™n ƒë·∫ßu trang
    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    // H√†m ki·ªÉm tra v·ªã tr√≠ cu·ªôn ƒë·ªÉ hi·ªÉn th·ªã n√∫t
    function toggleBackToTopButton() {
        const backToTopButton = document.getElementById('backToTop');
        if (window.scrollY > 300) {
            backToTopButton.classList.add('show');
        } else {
            backToTopButton.classList.remove('show');
        }
    }

    // T·∫£i d·ªØ li·ªáu v√† thi·∫øt l·∫≠p s·ª± ki·ªán
    window.onload = function() {
        loadSheetData();
        window.addEventListener('scroll', toggleBackToTopButton);
    };
    
    // Cho ph√©p t√¨m ki·∫øm b·∫±ng ph√≠m Enter
    document.getElementById("searchInput").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            searchStudent();
        }
    });
</script>

</body>
</html>